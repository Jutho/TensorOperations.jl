<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Cache for temporaries · TensorOperations.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">TensorOperations.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><span class="tocitem">Home</span><ul><li><a class="tocitem" href="../">TensorOperations.jl</a></li><li><a class="tocitem" href="../indexnotation/">Index notation with macros</a></li><li><a class="tocitem" href="../functions/">Functions</a></li><li class="is-active"><a class="tocitem" href>Cache for temporaries</a><ul class="internal"><li><a class="tocitem" href="#Enabling-and-disabling-the-cache"><span>Enabling and disabling the cache</span></a></li><li><a class="tocitem" href="#Cache-and-multithreading"><span>Cache and multithreading</span></a></li></ul></li><li><a class="tocitem" href="../implementation/">Implementation</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Home</a></li><li class="is-active"><a href>Cache for temporaries</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Cache for temporaries</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Jutho/TensorOperations.jl/blob/master/docs/src/cache.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Cache-for-temporaries"><a class="docs-heading-anchor" href="#Cache-for-temporaries">Cache for temporaries</a><a id="Cache-for-temporaries-1"></a><a class="docs-heading-anchor-permalink" href="#Cache-for-temporaries" title="Permalink"></a></h1><p>Contracting a sequence of tensors is provably most efficient (in terms of number of computations) by contracting them pairwise. However, this requires that several intermediate results need to be stored. In addition, if the contraction needs to be performed as a BLAS matrix multiplication (which is typically the fastest choice), every tensor typically needs an additional permuted copy that is compatible with the implementation of the contraction as multiplication. All these temporary arrays, which can be large, put a a lot of pressure on Julia&#39;s garbage collector, and the total time spent in the garbage collector can become significant.</p><p>That&#39;s why there is now a functionality to store intermediate results in a package wide cache, where they can be reused upon a next run, either a next iteration if the tensor contraction appears within the body of a loop, or on the next function call if it appears directly within a given function. This mechanism only works with the <code>@tensor</code> macro, not with the function-based interface.</p><p>The <code>@tensor</code> macro expands the given expression and immediately generates the code to create the necessary temporaries. It associates with each of them a random symbol (<code>gensym()</code>) and uses this as an identifier (together with the <code>Threads.threadid</code> of where it it is being evaluated) in a package wide global cache structure <code>TensorOperations.cache</code>, the implementation of which is a least-recently used cache dictionary from <a href="https://github.com/JuliaCollections/ LRUCache.jl">LRUCache.jl</a>. Thereto, it estimates the size of each object added to the cache using <code>Base.summarysize</code> and discards objects once a certain memory limit is reached.</p><h2 id="Enabling-and-disabling-the-cache"><a class="docs-heading-anchor" href="#Enabling-and-disabling-the-cache">Enabling and disabling the cache</a><a id="Enabling-and-disabling-the-cache-1"></a><a class="docs-heading-anchor-permalink" href="#Enabling-and-disabling-the-cache" title="Permalink"></a></h2><p>The use of the cache can be enabled or disabled using</p><article class="docstring"><header><a class="docstring-binding" id="TensorOperations.enable_cache" href="#TensorOperations.enable_cache"><code>TensorOperations.enable_cache</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">enable_cache(; maxsize::Int = ..., maxrelsize::Real = ...)</code></pre><p>(Re)-enable the cache for further use; set the maximal size <code>maxsize</code> (as number of bytes) or relative size <code>maxrelsize</code>, as a fraction between 0 and 1, resulting in <code>maxsize = floor(Int, maxrelsize * Sys.total_memory())</code>. Default value is <code>maxsize = 2^30</code> bytes, which amounts to 1 gigabyte of memory.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Jutho/TensorOperations.jl/blob/45e9bf580be961e6cb1ecaf7e28c3a0e1f77b9c1/src/TensorOperations.jl#L104-L110">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TensorOperations.disable_cache" href="#TensorOperations.disable_cache"><code>TensorOperations.disable_cache</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">disable_cache()</code></pre><p>Disable the cache for further use but does not clear its current contents. Also see <a href="#TensorOperations.clear_cache"><code>clear_cache()</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Jutho/TensorOperations.jl/blob/45e9bf580be961e6cb1ecaf7e28c3a0e1f77b9c1/src/TensorOperations.jl#L93-L98">source</a></section></article><p>Furthermore, the current total size of all the objects stored in the cache can be obtained using the method <code>cachesize</code>, and <code>clear_cache</code> can be triggered to release all the objects currently stored in the cache, such that they can be removed by Julia&#39;s garbage collector.</p><article class="docstring"><header><a class="docstring-binding" id="TensorOperations.cachesize" href="#TensorOperations.cachesize"><code>TensorOperations.cachesize</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">cachesize()</code></pre><p>Return the current memory size (in bytes) of all the objects in the cache.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Jutho/TensorOperations.jl/blob/45e9bf580be961e6cb1ecaf7e28c3a0e1f77b9c1/src/TensorOperations.jl#L134-L138">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="TensorOperations.clear_cache" href="#TensorOperations.clear_cache"><code>TensorOperations.clear_cache</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">clear_cache()</code></pre><p>Clear the current contents of the cache.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Jutho/TensorOperations.jl/blob/45e9bf580be961e6cb1ecaf7e28c3a0e1f77b9c1/src/TensorOperations.jl#L124-L128">source</a></section></article><h2 id="Cache-and-multithreading"><a class="docs-heading-anchor" href="#Cache-and-multithreading">Cache and multithreading</a><a id="Cache-and-multithreading-1"></a><a class="docs-heading-anchor-permalink" href="#Cache-and-multithreading" title="Permalink"></a></h2><p>The <code>LRU</code> cache currently is thread safe, but requires that temporary objects are allocated for every thread that is running <code>@tensor</code> expressions. If the same tensor contraction is evaluated by several threads (simultaneoulsy or not, this we cannot know), every thread needs to have its own set of temporary variables, so the &#39;same&#39; temporary will be stored in the cache multiple times. As indicated above, this is accomplished by associating with every temporary a randoms symbol and the <code>Threads.threadid</code> of the thread where the expression is being evaluated. If you have <code>JULIA_NUM_THREADS&gt;1</code> but always run tensor expressions on the main execution thread, no additional copies of the temporaries will be created.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../functions/">« Functions</a><a class="docs-footer-nextpage" href="../implementation/">Implementation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 5 October 2021 11:39">Tuesday 5 October 2021</span>. Using Julia version 1.6.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
